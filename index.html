<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Style Chat</title>
    <!-- Parse SDK -->
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        /* All CSS from previous example remains the same */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background-color: #d1d7db; } #auth-wrapper { display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; } .login-section { width: 100%; max-width: 400px; padding: 30px; background-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; text-align: center; } .login-section h2 { margin-top: 0; margin-bottom: 25px; color: #075E54; } .form-group { margin-bottom: 15px; text-align: left; } .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #333; } .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; } .form-button { width: 100%; padding: 12px; background-color: #128C7E; color: white; border: none; border-radius: 4px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 10px; } .form-button:hover { background-color: #075E54; } .error-message { color: #d93025; margin-top: 15px; font-size: 0.9em; height: 1em; } .chat-container { display: none; width: 100%; height: 100vh; flex-direction: column; background-color: #f0f0f0; } .chat-header { background-color: #075E54; color: white; padding: 10px 15px; display: flex; align-items: center; flex-shrink: 0; } .profile-pic { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; object-fit: cover; } .contact-info { display: flex; flex-direction: column; } .contact-name-line { display: flex; align-items: center; gap: 6px; } .contact-name-line h3 { margin: 0; font-size: 1.1em; } .verification-tick { width: 16px; height: 16px; color: #34B7F1; } .contact-info p { margin: 0; font-size: 0.8em; opacity: 0.8; } .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); } .message { max-width: 75%; padding: 8px 12px; border-radius: 10px; margin-bottom: 10px; line-height: 1.4; position: relative; word-wrap: break-word; } .message p { margin: 0; } .message.image-message { padding: 5px; background-color: transparent !important; } .message-image { max-width: 250px; border-radius: 6px; display: block; } .message.sent { background-color: #dcf8c6; align-self: flex-end; } .message.received { background-color: #ffffff; align-self: flex-start; } .timestamp { font-size: 0.7em; color: #888; display: block; text-align: right; margin-top: 4px; } .chat-input-form { display: flex; padding: 10px; background-color: #f0f0f0; border-top: 1px solid #ddd; align-items: center; flex-shrink: 0; } #message-input { flex-grow: 1; border: none; padding: 12px 20px; border-radius: 25px; font-size: 1em; min-width: 0; } #message-input:focus { outline: none; } .icon-button { background: none; border: none; cursor: pointer; padding: 0; margin-left: 10px; display: flex; align-items: center; justify-content: center; color: #54656f; flex-shrink: 0; } .icon-button svg { width: 24px; height: 24px; } #send-button { background-color: #128C7E; border: none; border-radius: 50%; width: 45px; height: 45px; margin-left: 10px; cursor: pointer; display: flex; justify-content: center; align-items: center; color: white; transition: background-color 0.2s; flex-shrink: 0; } #send-button:hover { background-color: #075E54; }
    </style>
</head>
<body>
    <div id="auth-wrapper">
        <div id="login-container" class="login-section">
            <h2>Enter Your Details</h2>
            <form id="login-form">
                <div class="form-group"><label for="full-name">Full Name</label><input type="text" id="full-name" required></div>
                <div class="form-group"><label for="nic">NIC Number (as Password)</label><input type="text" id="nic" required></div>
                <div class="form-group"><label for="whatsapp-no">WhatsApp Number (as Username)</label><input type="tel" id="whatsapp-no" placeholder="07xxxxxxxx" required></div>
                <div class="form-group"><label for="address">Address</label><textarea id="address" rows="2" required></textarea></div>
                <p class="error-message" id="login-error"></p>
                <button type="submit" class="form-button">Next</button>
            </form>
        </div>
        <div id="verification-container" class="login-section" style="display: none;">
            <h2>Enter Verification Code</h2>
            <p>A 5-digit code has been set by the admin. Please enter it below.</p>
            <form id="verification-form">
                <div class="form-group"><label for="code-input">Verification Code</label><input type="text" id="code-input" maxlength="5" style="text-align: center; font-size: 1.5em; letter-spacing: 10px;"></div>
                <p class="error-message" id="verification-error"></p>
                <button type="submit" class="form-button">Confirm & Login</button>
            </form>
        </div>
    </div>
    <div class="chat-container">
        <div class="chat-header"><img src="https://i.postimg.cc/HxHWwkV2/wa-94710957023-dp-1.jpg" alt="Profile Pic" class="profile-pic"><div class="contact-info"><div class="contact-name-line"><h3>Official Dana</h3><svg viewBox="0 0 24 24" class="verification-tick"><path fill="currentColor" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2m-2 15l-5-5 1.4-1.4 3.6 3.6 7.6-7.6L19 8l-9 9z"></path></svg></div><p>online</p></div></div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input-form"><input type="text" id="message-input" placeholder="Type a message..."><button class="icon-button" id="attach-button"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M16.5 6V17.5C16.5 19.71 14.71 21.5 12.5 21.5C10.29 21.5 8.5 19.71 8.5 17.5V5C8.5 3.62 9.62 2.5 11 2.5C12.38 2.5 13.5 3.62 13.5 5V15.5C13.5 16.05 13.05 16.5 12.5 16.5C11.95 16.5 11.5 16.05 11.5 15.5V6H10V15.5C10 16.88 11.12 18 12.5 18C13.88 18 15 16.88 15 15.5V5C15 2.79 13.21 1 11 1C8.79 1 7 2.79 7 5V17.5C7 20.26 9.24 22.5 12 22.5C14.76 22.5 17 20.26 17 17.5V6H16.5Z"></path></svg></button><button id="send-button"><svg viewBox="0 0 24 24"><path fill="currentColor" d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg></button></div>
    </div>
    <input type="file" id="image-input" accept="image/*" style="display: none;">

    <script>
        // No Master Key here - this is the public-facing user app.
        Parse.initialize("7FZk3EhStsRxtd5kSkjx4WNuWYwHljw7oAHe0xeA", "tjbj3H5HZ5Qyx3HGiTB9LMtkDIy1G2eCFYWcnCIm");
        Parse.serverURL = 'https://parseapi.back4app.com';

        const authWrapper = document.getElementById('auth-wrapper');
        const loginContainer = document.getElementById('login-container');
        const verificationContainer = document.getElementById('verification-container');
        const chatContainer = document.querySelector('.chat-container');
        const loginForm = document.getElementById('login-form');
        const verificationForm = document.getElementById('verification-form');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const attachButton = document.getElementById('attach-button');
        const imageInput = document.getElementById('image-input');
        
        let currentChatSession = null;
        let messageSubscription = null;

        window.addEventListener('load', async () => {
            const currentUser = Parse.User.current();
            if (currentUser && currentUser.get('isVerified')) {
                await showChatScreen(currentUser);
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('full-name').value.trim();
            const nic = document.getElementById('nic').value.trim();
            const whatsappNo = document.getElementById('whatsapp-no').value.trim();
            const address = document.getElementById('address').value.trim();
            const loginError = document.getElementById('login-error');
            loginError.textContent = 'Processing...';

            try {
                await Parse.User.logIn(whatsappNo, nic);
            } catch (error) {
                if (error.code === 101) {
                    const user = new Parse.User();
                    user.set('username', whatsappNo);
                    user.set('password', nic);
                    user.set('fullName', fullName);
                    user.set('nic', nic);
                    user.set('address', address);
                    user.set('isVerified', false);
                    try {
                        await user.signUp();
                    } catch (signUpError) {
                        loginError.textContent = `Registration Error: ${signUpError.message}`;
                        return;
                    }
                } else {
                    loginError.textContent = `Login Error: ${error.message}`;
                    return;
                }
            }
            
            loginContainer.style.display = 'none';
            verificationContainer.style.display = 'block';
            loginError.textContent = '';
        });

        verificationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const enteredCode = document.getElementById('code-input').value.trim();
            const verificationError = document.getElementById('verification-error');
            const currentUser = Parse.User.current();

            if (!enteredCode) { verificationError.textContent = 'Please enter the code.'; return; }
            
            try {
                verificationError.textContent = 'Verifying...';
                await currentUser.fetch();
                
                if (currentUser.get('adminCode') === enteredCode) {
                    currentUser.set('isVerified', true);
                    await currentUser.save();
                    await showChatScreen(currentUser);
                } else {
                    verificationError.textContent = 'Invalid verification code. Please check and try again.';
                }
            } catch (error) {
                verificationError.textContent = `Error: ${error.message}`;
            }
        });

        async function showChatScreen(user) {
            authWrapper.style.display = 'none';
            chatContainer.style.display = 'flex';
            
            const ChatSession = Parse.Object.extend('ChatSession');
            const query = new Parse.Query(ChatSession);
            query.equalTo('user', user);
            currentChatSession = await query.first();

            if (!currentChatSession) {
                currentChatSession = new ChatSession();
                currentChatSession.set('user', user);
                currentChatSession.set('lastActivity', new Date());
                currentChatSession.set('lastMessagePreview', 'New chat started.');
                currentChatSession.set('agentUnreadCount', 1);
                
                const acl = new Parse.ACL();
                acl.setReadAccess(user, true);
                acl.setWriteAccess(user, true);
                acl.setRoleReadAccess("Admin", true);
                acl.setRoleWriteAccess("Admin", true);
                currentChatSession.setACL(acl);

                await currentChatSession.save();
            }

            loadMessages();
            subscribeToMessages();
        }

        async function loadMessages() {
            chatMessages.innerHTML = '';
            const Message = Parse.Object.extend('Message');
            const query = new Parse.Query(Message);
            query.equalTo('session', currentChatSession);
            query.ascending('createdAt');
            const results = await query.find();
            results.forEach(createMessageBubble);
        }

        async function subscribeToMessages() {
            if(messageSubscription) messageSubscription.unsubscribe();

            const query = new Parse.Query('Message');
            query.equalTo('session', currentChatSession);
            messageSubscription = await query.subscribe();

            messageSubscription.on('create', (message) => {
                if (message.get('sender') === 'agent') {
                    createMessageBubble(message);
                }
            });
        }

        async function sendMessage(text, imageFile = null) {
            const Message = Parse.Object.extend('Message');
            const message = new Message();

            message.set('sender', 'user');
            message.set('session', currentChatSession);
            
            if (text) message.set('text', text);
            if (imageFile) {
                const parseFile = new Parse.File(imageFile.name, imageFile);
                await parseFile.save();
                message.set('image', parseFile);
            }

            const acl = new Parse.ACL();
            acl.setReadAccess(Parse.User.current(), true);
            acl.setRoleReadAccess("Admin", true);
            message.setACL(acl);
            
            try {
                const savedMessage = await message.save();
                createMessageBubble(savedMessage);
                
                currentChatSession.set('lastActivity', new Date());
                currentChatSession.set('lastMessagePreview', text ? text : 'ðŸ“· Photo');
                currentChatSession.increment('agentUnreadCount');
                await currentChatSession.save();

            } catch (error) {
                console.error('Error sending message: ', error);
                alert('Could not send message. Please check your connection.');
            }
        }

        function createMessageBubble(msg) {
            const type = msg.get('sender') === 'user' ? 'sent' : 'received';
            const text = msg.get('text');
            const image = msg.get('image');
            
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            
            if (image) {
                messageDiv.classList.add('image-message');
                const imageEl = document.createElement('img');
                imageEl.src = image.url();
                imageEl.classList.add('message-image');
                messageDiv.appendChild(imageEl);
            }
            if (text) {
                const textP = document.createElement('p');
                textP.textContent = text;
                messageDiv.appendChild(textP);
            }
            
            const timeSpan = document.createElement('span');
            timeSpan.classList.add('timestamp');
            timeSpan.textContent = new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            messageDiv.appendChild(timeSpan);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        sendButton.addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text) {
                sendMessage(text, null);
                messageInput.value = '';
            }
        });
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendButton.click(); } });
        
        attachButton.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                sendMessage(null, file);
                imageInput.value = '';
            }
        });

    </script>
</body>
</html>
